<!-- 
templates/dash_matrix.html
Version: 0.0.2.0
Description: Dashboard with Matrix styling.
-->
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Shepherd - Digital Stream</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { overflow: hidden; background-color: #000; }
        canvas { display: block; }
        .font-numeric { font-family: Verdana, sans-serif; }
    </style>
</head>
<body class="bg-black text-gray-200 font-mono h-full" onclick="toggleMenu(event)">
    <canvas id="matrix-canvas"></canvas>

    <!-- Overlay Content -->
    <div class="absolute inset-0 flex flex-col justify-between p-4">
        
        <!-- Top Bar: BTC Price -->
        <div class="bg-black/50 p-3 rounded-md text-left">
            <p class="text-sm text-green-400 uppercase font-bold">BTC Price</p>
            <div class="flex justify-between items-center mt-1">
                <p id="btc-price" class="text-7xl font-semibold font-numeric">
                    $--,--
                </p>
                <div class="flex flex-col items-center">
                    <svg id="btc-arrow-up" class="h-5 w-5 text-green-500 hidden" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 4l-6 8h12l-6-8z" />
                    </svg>
                    <p id="btc-change" class="text-xl font-semibold mt-1 mb-1 font-numeric">
                        --.--%
                    </p>
                    <svg id="btc-arrow-down" class="h-5 w-5 text-red-500 hidden" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 16l6-8H4l6 8z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Middle Stats -->
        <div class="grid grid-cols-4 gap-2 text-center">
            <div class="bg-black/50 p-2 rounded-md">
                <p class="text-xs text-green-400 uppercase font-bold">Miners</p>
                <p id="miners-stats" class="text-2xl font-semibold font-numeric">--/--</p>
            </div>
            <div class="bg-black/50 p-2 rounded-md">
                <p class="text-xs text-green-400 uppercase font-bold">Herd Hash</p>
                <p id="hash-stats" class="text-2xl font-semibold font-numeric">--.--</p>
            </div>
            <div class="bg-black/50 p-2 rounded-md">
                <p class="text-xs text-green-400 uppercase font-bold">Shares</p>
                <p id="shares-stats" class="text-2xl font-semibold font-numeric">--</p>
            </div>
            <div class="bg-black/50 p-2 rounded-md">
                <p class="text-xs text-green-400 uppercase font-bold">Templates</p>
                <p id="templates-stats" class="text-2xl font-semibold font-numeric">--</p>
            </div>
        </div>

        <!-- Bottom Bar: Clock -->
        <div class="bg-black/50 p-3 rounded-md text-center">
            <p id="clock-time" class="text-5xl font-semibold font-numeric"></p>
            <p id="clock-date" class="text-xl font-semibold text-gray-400 font-numeric"></p>
        </div>

    </div>

    {% include '_navigation_menu.html' %}

    <script>
        const canvas = document.getElementById('matrix-canvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
        const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const nums = '0123456789';
        const alphabet = katakana + latin + nums;

        const fontSize = 16;
        const columns = canvas.width / fontSize;
        const rainDrops = [];
        for (let x = 0; x < columns; x++) { rainDrops[x] = 1; }

        const drawMatrix = () => {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#0F0';
            ctx.font = fontSize + 'px monospace';
            for (let i = 0; i < rainDrops.length; i++) {
                const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
                ctx.fillText(text, i * fontSize, rainDrops[i] * fontSize);
                if (rainDrops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    rainDrops[i] = 0;
                }
                rainDrops[i]++;
            }
        };

        function updateClock() {
            const timeElement = document.getElementById('clock-time');
            const dateElement = document.getElementById('clock-date');
            if (!timeElement || !dateElement) return;
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            const dateString = now.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric' });
            timeElement.textContent = timeString;
            dateElement.textContent = dateString;
        }

        async function refreshData() {
            try {
                // CHANGED: Pointing to the new unified API endpoint
                const response = await fetch('/api/herd_data');
                if (!response.ok) throw new Error("Network response was not ok");
                
                const data = await response.json();
                
                // Update BTC Price and Change
                const btcData = data.btc_price_data;
                document.getElementById('btc-price').textContent = `$${btcData.price_usd.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
                
                const change = btcData.change_24h;
                const changeEl = document.getElementById('btc-change');
                const arrowUp = document.getElementById('btc-arrow-up');
                const arrowDown = document.getElementById('btc-arrow-down');

                changeEl.textContent = `${change.toFixed(2)}%`;
                if (change >= 0) {
                    changeEl.classList.remove('text-red-500');
                    changeEl.classList.add('text-green-500');
                    arrowUp.classList.remove('hidden');
                    arrowDown.classList.add('hidden');
                } else {
                    changeEl.classList.remove('text-green-500');
                    changeEl.classList.add('text-red-500');
                    arrowUp.classList.add('hidden');
                    arrowDown.classList.remove('hidden');
                }
                
                // Update Middle Stats
                const herdStats = data.herd_stats;
                document.getElementById('miners-stats').textContent = `${herdStats.online_miners}/${herdStats.total_miners}`;
                document.getElementById('hash-stats').textContent = herdStats.total_hash_khs.toFixed(2);
                document.getElementById('shares-stats').textContent = herdStats.total_shares.toLocaleString('en-US');
                document.getElementById('templates-stats').textContent = herdStats.total_block_templates.toLocaleString('en-US');

            } catch (error) {
                console.error('Failed to refresh data:', error);
            }
        }

        // --- Start Intervals ---
        setInterval(drawMatrix, 30);
        setInterval(updateClock, 1000);
        // CHANGED: Matrix now updates every 5 seconds to match other dashboards
        setInterval(refreshData, 5000); 

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            updateClock();
            refreshData();
        });

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const newColumns = canvas.width / fontSize;
            for (let x = 0; x < newColumns; x++) {
                if (!rainDrops[x]) rainDrops[x] = 1;
            }
        });
        
        function toggleMenu(event) {
            if (event && event.target.closest('a')) { return; }
            event.stopPropagation();
            document.getElementById('nav-menu-overlay').classList.toggle('hidden');
            document.getElementById('nav-menu-panel').classList.toggle('-translate-x-full');
        }
    </script>

</body>
</html>

