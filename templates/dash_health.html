<!-- V.0.0.0.2 -->
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Herd Health</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-black text-gray-200 font-sans h-full" onclick="toggleMenu(event)">
    <div class="h-full flex flex-col">

        <!-- Header -->
        <header id="page-header" class="flex-shrink-0 bg-gray-800 p-2 rounded-b-lg grid grid-cols-2 gap-2 text-center">
            <div class="text-left">
                <h1 id="clock-time" class="text-xl font-bold"></h1>
                <p id="clock-date" class="text-xs text-cyan-400"></p>
            </div>
            <div class="bg-yellow-400 text-black p-1 rounded-md">
                <p class="text-xs font-bold uppercase">BTC Price</p>
                <p class="text-sm font-semibold">
                    <span id="btc-price">$--,--</span>
                    <span id="btc-change" class="">(--.--)%</span>
                </p>
            </div>
        </header>

        <!-- Main Content: Miner Grid -->
        <main id="miner-list" class="flex-grow overflow-y-auto p-1 no-scrollbar grid grid-cols-5 gap-1">
            <p class="col-span-full text-center text-gray-500 pt-8">Loading miners...</p>
        </main>

        <!-- Footer -->
        <footer id="page-footer" class="flex-shrink-0 bg-gray-800 p-2 rounded-t-lg grid grid-cols-3 gap-2 text-center">
            <div>
                <p class="text-xs text-cyan-400 uppercase font-bold">Total Hash</p>
                <p id="total-hash" class="text-lg font-semibold">--.--</p>
            </div>
            <div>
                <p class="text-xs text-cyan-400 uppercase font-bold">Shares</p>
                <p id="total-shares" class="text-lg font-semibold">--</p>
            </div>
            <div>
                <p class="text-xs text-cyan-400 uppercase font-bold">Templates</p>
                <p id="total-templates" class="text-lg font-semibold">--</p>
            </div>
        </footer>
    </div>
    
    {% include '_navigation_menu.html' %}

    <script>
        function updateClock() {
            const timeElement = document.getElementById('clock-time');
            const dateElement = document.getElementById('clock-date');
            if (!timeElement || !dateElement) return;
            const now = new Date();
            timeElement.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            dateElement.textContent = now.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
        }
        setInterval(updateClock, 1000);
        updateClock();

        async function refreshData() {
            try {
                const response = await fetch('/api/herd_data');
                const data = await response.json();

                // Update Header Stats
                const btcData = data.btc_price_data;
                document.getElementById('btc-price').textContent = `$${btcData.price_usd.toLocaleString('en-US', {maximumFractionDigits: 2})}`;
                const btcChangeEl = document.getElementById('btc-change');
                btcChangeEl.textContent = `(${btcData.change_24h.toFixed(2)}%)`;
                btcChangeEl.className = btcData.change_24h >= 0 ? 'text-green-800' : 'text-red-800';

                // Update Footer Stats
                const herdStats = data.herd_stats;
                document.getElementById('total-hash').textContent = herdStats.total_hash_khs.toFixed(2);
                document.getElementById('total-shares').textContent = herdStats.total_shares.toLocaleString('en-US');
                document.getElementById('total-templates').textContent = herdStats.total_block_templates.toLocaleString('en-US');

                // Update Miner Grid
                const minerListEl = document.getElementById('miner-list');
                minerListEl.innerHTML = ''; // Clear current content
                
                if (!data.miners_list || data.miners_list.length === 0) {
                    minerListEl.innerHTML = '<p class="col-span-full text-center text-gray-500 pt-8">No miners found.</p>';
                    return;
                }

                data.miners_list.forEach(miner => {
                    const minerBubble = document.createElement('a');
                    minerBubble.href = `/details/miner/${miner.id}`;
                    
                    let classes = 'aspect-square rounded-md flex flex-col items-center justify-center p-1 text-center ';
                    const khs = miner['KH/s'] ? parseFloat(miner['KH/s']).toFixed(2) : 'N/A';
                    let innerHTML = '';

                    if (miner.status === 'offline') {
                        classes += 'bg-red-900/50 border border-red-700';
                        innerHTML = `
                            <p class="font-bold text-[11px]">${miner.miner_id}</p>
                            <p class="text-[10px] text-red-400 mt-1">Offline</p>
                        `;
                    } else {
                        classes += 'bg-gray-800';
                        innerHTML = `
                            <p class="font-bold text-[11px]">${miner.miner_id}</p>
                            <p class="font-semibold text-sm text-cyan-300">${khs}</p>
                        `;
                    }
                    
                    minerBubble.className = classes;
                    minerBubble.innerHTML = innerHTML;
                    minerListEl.appendChild(minerBubble);
                });

            } catch (error) {
                console.error('Failed to refresh data:', error);
            }
        }
        setInterval(refreshData, 5000); 
        document.addEventListener('DOMContentLoaded', refreshData);
    </script>
</body>
</html>

